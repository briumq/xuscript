// 测试Result.map返回结构体失败问题

// 定义结构体
Token has {
    role: string
    exp: int

    static func create(role: string, exp: int) -> Token {
        return Token{ role: role, exp: exp }
    }
}

// 定义一个返回Result的函数
func parse_role(type_str: string) -> Result[string, string] {
    if type_str == "admin" {
        return Result#ok("admin")
    } else if type_str == "user" {
        return Result#ok("user")
    } else {
        return Result#err("Invalid role")
    }
}

// 测试函数
func test_result_map_bug() {
    println("=== 测试Result.map返回结构体失败问题 ===")

    // 测试1: Result.map返回结构体（应该失败）
    println("\n测试1: Result.map返回结构体")
    println("期望: Token{ role: admin, exp: 3600 }")
    let result = parse_role("admin").map(func(role: string) -> Token {
        return Token::create(role, 3600)
    })
    match result {
        Result#ok(token) {
            println("实际: Token created successfully")
            println("Role: {token.role}")
            println("Exp: {token.exp}")
        }
        Result#err(error) {
            println("错误: {error}")
        }
        _ {
            println("未知结果")
        }
    }

    // 测试2: 使用显式match语句（应该成功）
    println("\n测试2: 使用显式match语句")
    println("期望: Token{ role: admin, exp: 3600 }")
    let result2 = parse_role("admin")
    let token_result = match result2 {
        Result#ok(role) {
            Result#ok(Token::create(role, 3600))
        }
        Result#err(error) {
            Result#err(error)
        }
        _ {
            Result#err("Unknown error")
        }
    }
    match token_result {
        Result#ok(token) {
            println("实际: Token created successfully")
            println("Role: {token.role}")
            println("Exp: {token.exp}")
        }
        Result#err(error) {
            println("错误: {error}")
        }
        _ {
            println("未知结果")
        }
    }
}

// 主函数
func main() {
    test_result_map_bug()
}

// 调用主函数
main()