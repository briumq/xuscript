// Better GC leak test - dict created in separate function
func create_dict(n: int) {
    let d: dict[str, int] = {}
    var i = 0
    while i < n {
        d.insert("key" + to_text(i), i)
        i = i + 1
    }
    // d goes out of scope when function returns
}

func test_gc_leak() {
    print("Initial RSS: " + to_text(process_rss()))

    var round = 1
    while round <= 5 {
        print("=== Round " + to_text(round) + " ===")
        print("Before creation RSS: " + to_text(process_rss()))

        create_dict(100000)  // dict goes out of scope after function returns
        print("After creation RSS: " + to_text(process_rss()))

        gc()  // now d should be out of scope
        print("After GC RSS: " + to_text(process_rss()))

        round = round + 1
    }

    print("Final RSS: " + to_text(process_rss()))
}

test_gc_leak()
