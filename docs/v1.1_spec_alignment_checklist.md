# XuScript v1.1 规范对齐检查清单

## 一、关键字 (24 + 4 预留)

### 控制流关键字
| 关键字 | 规范要求 | 实现状态 | 备注 |
|--------|----------|----------|------|
| `if` | 条件语句/表达式 | ✅ | |
| `else` | 条件分支 | ✅ | |
| `while` | 循环 | ✅ | |
| `for` | 迭代循环 | ✅ | |
| `in` | 迭代范围 | ✅ | |
| `break` | 跳出循环 | ✅ | |
| `continue` | 继续循环 | ✅ | |
| `match` | 模式匹配 | ✅ | 默认分支用 `_` |
| `when` | Option/Result 解包 | ✅ | 仅作语句 |

### 定义关键字
| 关键字 | 规范要求 | 实现状态 | 备注 |
|--------|----------|----------|------|
| `let` | 不可变绑定 | ✅ | |
| `var` | 可变绑定 | ✅ | |
| `func` | 函数定义 | ✅ | |
| `return` | 返回值 | ✅ | |
| `has` | 结构体定义 | ✅ | |
| `with` | 枚举定义 | ✅ | |
| `does` | 扩展方法 | ✅ | |

### 修饰关键字
| 关键字 | 规范要求 | 实现状态 | 备注 |
|--------|----------|----------|------|
| `pub` | 公开可见性 | ✅ | 默认私有，`pub` 标记公开 |
| `static` | 静态方法 | ✅ | `static func` 支持 |

### 字面关键字
| 关键字 | 规范要求 | 实现状态 | 备注 |
|--------|----------|----------|------|
| `self` | 实例引用 | ✅ | |
| `true` | 布尔真 | ✅ | |
| `false` | 布尔假 | ✅ | |

### 逻辑运算符 (已优化)
| 符号 | 用途 | 实现状态 | 备注 |
|------|------|----------|------|
| `!` | 逻辑非 | ✅ | 前缀运算符 |
| `&&` | 逻辑与 | ✅ | 短路求值 |
| `\|\|` | 逻辑或 | ✅ | 短路求值 |
| `==` | 相等比较 | ✅ | |
| `!=` | 不等比较 | ✅ | |

**已移除的关键字**：`not`, `and`, `or`, `isnt` (改用符号)

### 模块关键字
| 关键字 | 规范要求 | 实现状态 | 备注 |
|--------|----------|----------|------|
| `use` | 模块导入 | ✅ | |
| `as` | 别名 | ✅ | |

### 预留关键字
| 关键字 | 规范要求 | 实现状态 | 备注 |
|--------|----------|----------|------|
| `is` | 预留 | ✅ | 不可作标识符 |
| `can` | 预留 | ✅ | 不可作标识符 |
| `async` | 预留 | ✅ | 不可作标识符 |
| `await` | 预留 | ✅ | 不可作标识符 |

---

## 二、类型系统

### 基本类型
| 类型 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| `int` | 整数 | ✅ | |
| `float` | 浮点数 | ✅ | |
| `string` | 字符串 | ✅ | 支持插值 |
| `bool` | 布尔值 | ✅ | |
| `unit` | 空类型 | ✅ | 已单元类型 |
| `any` | 任意类型 | ✅ | 规范文档待补充 |

### 集合类型
| 类型 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| 列表 `[T]` | 类型标注语法 | ✅ | |
| 字典 `{K: V}` | 类型标注语法 | ✅ | |
| 集合 `{T}` | 类型标注语法 | ✅ | |
| 元组 `(T1, T2)` | 类型标注语法 | ✅ | 类型系统归为 any |
| 范围 `..` `..=` | 整数范围 | ✅ | |

### 空容器类型标注
| 场景 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| `let xs: [int] = []` | 必须标注 | ✅ | |
| `let m: {string: int} = {}` | 必须标注 | ✅ | |

### 结构体与枚举
| 特性 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| 字段默认值 | `field: T = default` | ✅ | |
| 静态方法 | `static func` | ✅ | |
| 静态字段 | `static var` | 不支持 | static 只修饰func |
| 扩展方法 | `does` 块 | ✅ | |
| 内置类型扩展限制 | 禁止扩展 int/string/bool | ✅ | |

### Option 与 Result
| 组合子 | 规范要求 | 实现状态 | 备注 |
|--------|----------|----------|------|
| `.has` | 是否有值 | ✅ | |
| `.none` | 是否无值 | ✅ | |
| `.or(v)` | 默认值 | ✅ | |
| `.or_else(func)` | 惰性默认值 | ✅ | |
| `.map(func)` | 映射变换 | ✅ | |
| `.then(func)` | 链式操作 | ✅ | |
| `.each(func)` | 有值则执行 | ✅ | |
| `.filter(pred)` | 过滤 | ✅ | |
| `.map_err(func)` | Result 错误转换 | ✅ | |

---

## 三、变量与作用域

| 规则 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| 未声明变量赋值 | 编译错误 | ✅ | 默认严格模式 |
| `let` 变量重新赋值 | 编译错误 | ✅ | |
| 禁止遮蔽 | 内层不得声明同名变量 | ✅ | |
| unit 赋值 | 编译错误 | ✅ | `let x = ()` 报错 |

---

## 四、容器访问

| 方式 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| 强访问 `list[i]` | 越界 panic | ✅ | |
| 强访问 `map[k]` | 缺失 panic | ✅ | |
| 安全访问 `list.get(i)` | 返回 Option | ✅ | |
| 安全访问 `map.get(k)` | 返回 Option | ✅ | |
| 安全访问 `str.get(i)` | 返回 Option | ✅ | |
| 安全访问 `list.first` | 返回 Option | ✅ | |

---

## 五、模块与可见性

| 特性 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| `use "path"` | 模块导入 | ✅ | |
| `use "path" as alias` | 别名导入 | ✅ | |
| 默认私有 | 顶层定义私有 | ✅ | |
| `pub` 公开 | 标记公开可见 | ✅ | |

---

## 六、控制流

| 特性 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| if 语句 | else 可省略 | ✅ | |
| if 表达式 | 必须有 else | ✅ | |
| 单语句简写 `:` | `if x > 0: return` | ✅ | |
| match 默认分支 | 使用 `_` | ✅ | |
| when 语句 | 仅作语句，else 可选 | ✅ | 省略 else 时 none/err 不执行任何操作 |
| when 多绑定 | 短路求值 | ✅ | |

---

## 七、列表方法

| 方法 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| `.push(v)` | 添加元素 | ✅ | |
| `.remove(i)` | 移除元素 | ✅ | |
| `.pop()` | 弹出末尾 | ✅ | |
| `.clear()` | 清空 | ✅ | |
| `.contains(v)` | 包含检查 | ✅ | |
| `.reverse()` | 反转 | ✅ | |
| `.join(sep)` | 连接为字符串 | ✅ | |
| `.filter(func)` | 过滤 | ✅ | |
| `.map(func)` | 映射 | ✅ | |
| `.length` | 长度属性 | ✅ | |
| `.first` | 返回 Option | ✅ | |
| `.get(i)` | 安全访问 | ✅ | |

---

## 八、字典方法

| 方法 | 规范要求 | 实现状态 | 备注 |
|------|----------|----------|------|
| `.insert(k, v)` | 插入 | ✅ | |
| `.get(k)` | 安全访问 | ✅ | 返回 Option |
| `.remove(k)` | 移除 | ✅ | |
| `.has(k)` | 包含检查 | ✅ | |
| `.clear()` | 清空 | ✅ | |
| `.merge(other)` | 合并 | ✅ | |
| `.keys()` | 键列表 | ✅ | |
| `.values()` | 值列表 | ✅ | |

---

## 九、规范有但待验证/实现的功能

| 功能 | 规范位置 | 实现状态 | 备注 |
|------|----------|----------|------|
| 元组解构 `let (x, y) = (1, 2)` | 4.1 | ✅ 已修复 | 顶层和函数内均可用 |
| 多返回值解构 `let (q, r) = div(10, 3)` | 6.1 | ✅ 已修复 | 顶层和函数内均可用 |
| 字典键值对循环 `for (key, value) in map` | 7.2 | ✅ 已实现 | 支持 `for (k, v) in dict` 语法 |
| 字典 `.length` 属性 | - | ✅ 已实现 | 测试通过 |
| 字符串 `.to_int()` 方法 | 标准库 1.3 | ✅ 已实现 | 测试通过 |
| 整数 `.to_string()` 方法 | - | ✅ 已实现 | `42.to_string()` 返回 `"42"` |
| 浮点数 `.to_string()` 方法 | - | ✅ 已实现 | `3.14.to_string()` 返回 `"3.14"` |
| 浮点数 `.to_int()` 方法 | - | ✅ 已实现 | `3.14.to_int()` 返回 `3`（截断取整） |

---

## 十、示例代码问题清单

以下是示例代码中使用了但**不符合规范**的写法：

| 错误写法 | 正确写法 | 影响文件 |
|----------|----------|----------|
| `A has B { }` (结构体继承) | 不支持继承，使用组合 | data_processing_pipeline.xu |
| `let mut x = ...` | `var x = ...` | data_processing_pipeline.xu |
| `expr as Type` (类型转换) | 不支持，`as` 仅用于模块别名 | data_processing_pipeline.xu |
| `Math.random()` | `use "math"` 后 `math.random()` | ecommerce_checkout.xu |
| `str.none` (字符串空检查) | `str.length == 0` 或 `str == ""` | ecommerce_checkout.xu |
| `int.to_string()` | ✅ 现已支持 `n.to_string()` | 多个文件 |
| `dict.size` | `dict.length` | language_features_demo.xu |
| `when ... { } ` (无 else) | ✅ 现已支持（else 可省略） | language_features_demo.xu |

---

## 十二、运行时 Bug 跟踪

以下是在示例代码测试中发现的运行时 bug：

| Bug 描述 | 触发条件 | 错误信息 | 状态 | 备注 |
|----------|----------|----------|------|------|
| 内联 match 表达式赋值失败 | `let val = match expr { ... }` | `RuntimeError: Format requires Dict argument` | ✅ 已修复 | 现在可以正常使用 |
| Result.map 返回结构体失败 | `result.map(|x| -> Struct { Struct{...} })` | `RuntimeError: Unsupported member access: field on type unit` | ✅ 已修复 | 现在可以正常使用 |
| to_float() 无效输入抛出错误 | `"invalid".to_float()` | `RuntimeError: Failed to parse float` | ⚠️ 设计如此 | 使用 `try_to_float()` 返回 Option 来安全处理 |

### 绕过方案示例

**内联 match 表达式问题**：
```xu
// ❌ 会报错
let val = match cache.get("a") { Option#some(v){v} _ {-1} }

// ✅ 绕过方案 1：分开写
let result = cache.get("a")
let val = match result { Option#some(v){v} _ {-1} }

// ✅ 绕过方案 2：使用辅助函数
func unwrap_or(opt: Option[int], default: int) -> int {
    match opt {
        Option#some(v) { return v }
        _ { return default }
    }
}
let val = unwrap_or(cache.get("a"), -1)
```

**Result.map 返回结构体问题**：
```xu
// ❌ 会报错
return parse_role(type_str).map(|role: Role| -> Token {
    Token{ role: role, exp: exp }
})

// ✅ 绕过方案：使用显式 match
match parse_role(type_str) {
    Result#ok(role) {
        return Result#ok(Token{ role: role, exp: exp })
    }
    Result#err(e) {
        return Result#err(e)
    }
    _ {
        return Result#err("Unknown error")
    }
}
```

---

## 十三、验证命令

```bash
# 构建
cargo build

# 运行测试
cargo test

# 检查示例
xu check examples/

# 运行示例
xu run examples/
```

---
